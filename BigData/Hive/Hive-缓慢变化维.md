### 解决缓慢变化维



什么是缓慢变化维（SCD)、

1、缓慢变化维简介

    缓慢变化维，简称SCD（Slowly Changing Dimensions）
    一些维度表的数据不是静态的，而是会随着时间而缓慢地变化（这里的缓慢是相对事实表而言，事实表数据变化的速度比维度表快）
    这种随着时间发生变化的维度称之为缓慢变化维
    把处理维度表数据历史变化的问题，称为缓慢变化维问题，简称SCD问题

 


2、举例说明

例如：用根据用户维度，统计不同出生年份的消费金额占比。（80后、90后、00后）。

而期间，用户可能去修改用户数据，例如：将出生日期改成了 1992年。此时，用户维度表就发生了变化。当然这个变化相对事实表的变换要慢。但这个用户维度表的变化，就是缓慢变化维。

| **用户ID** | **用户名** | **出生日期** | **住址**     |
| ---------- | ---------- | ------------ | ------------ |
| 114        | 张三       | 1988-09-08   | 北京市朝阳区 |



这个用户的数据不是一直不变，而是有可能发生变化。例如：用户修改了出生日期、或者用户修改了住址。

 

4.2 SCD问题的几种解决方案

以下为解决缓慢变化维问题的几种办法：

- 保留原始值
- 改写属性值
- 增加维度新行
- 增加维度新列
- 添加历史表



**SCD解决方案 - 保留原始值**

某一个属性值绝不会变化。事实表始终按照该原始值进行分组。例如：

- 出生日期的数据，始终按照用户第一次填写的数据为准



**SCD解决方案 - 改写属性值**

- 对其相应需要重写维度行中的旧值，以当前值替换。因此其始终反映最近的情况。
  当一个维度值的数据源发生变化，并且不需要在维度表中保留变化历史时，通常用新数据来覆盖旧数据。这样的处理使属性所反映的中是最新的赋值。



用户维度表

修改前：

| **用户ID** | **用户名** | **出生日期** | **住址**     |
| ---------- | ---------- | ------------ | ------------ |
| 114        | 张三       | 1988-09-08   | 北京市朝阳区 |

修改后：

| **用户ID** | **用户名** | *出生日期** | **住址**   |
| ---------- | ---------- | ----------- | ---------- |
| 114        | 张三       | 1992-09-08  | 北京海淀区 |

- 这种方法有个前提，用户不关心这个数据的变化

- 这样处理，易于实现，但是没有保留历史数据，无法分析历史变化信息


**SCD解决方案 -** **增加维度新行**

数据仓库系统的目标之一是正确地表示历史。典型代表就是**拉链表**。

保留历史的数据，并插入新的数据。

用户维度表

修改前：

| 编号 | **用户ID** | **用户名** | **出生日期** | **住址**     |
| ---- | ---------- | ---------- | ------------ | ------------ |
| 9527 | 114        | 张三       | 1988-09-08   | 北京市朝阳区 |

修改后：

| 编号 | **用户ID** | **用户名** | **出生日期** | **住址**     |
| ---- | ---------- | ---------- | ------------ | ------------ |
| 9527 | 114        | 张三       | 1988-09-08   | 北京市朝阳区 |
| 9528 | 114        | 张三       | 1992-09-08   | 北京海淀区   |



**SCD解决方案 -** **增加维度新列**

用不同的字段来保存不同的值，就是在表中增加一个字段，这个字段用来保存变化后的当前值，而原来的值则被称为变化前的值。总的来说，这种方法通过添加字段来保存变化后的痕迹。

用户维度表

修改前：

| **编号** | **用户ID** | **用户名** | **出生日期** | **住址**     |
| -------- | ---------- | ---------- | ------------ | ------------ |
| 9527     | 114        | 张三       | 1988-09-08   | 北京市朝阳区 |

修改后：

| **编号** | **用户ID** | **用户名** | **出生日期** |                | **住址**     | **现住址**       |
| -------- | ---------- | ---------- | ------------ | -------------- | ------------ | ---------------- |
| 9527     | 114        | 张三       | 1988-09-08   | **1992-09-08** | 北京市朝阳区 | **北京市海淀区** |

**SCD解决方案 -** **使用历史表**

另外建一个表来保存历史记录，这种方式就是将历史数据与当前数据完全分开来，在维度中只保存当前最新的数据。 

用户维度表

| **编号** | **用户ID** | **用户名** | **出生日期** | **住址**     |
| -------- | ---------- | ---------- | ------------ | ------------ |
| 9527     | 114        | 张三       | 1992-09-08   | 北京市海淀区 |

用户维度历史表

| **编号** | **用户ID** | **用户名** | **出生日期** | **住址**     |
| -------- | ---------- | ---------- | ------------ | ------------ |
| 9537     | 114        | 张三       | 1988-09-02   | 北京市朝阳区 |
| 9527     | 114        | 张三       | 1992-09-08   | 北京市海淀区 |

这种方式的优点是可以同时分析当前及前一次变化的属性值，缺点是只保留了最后一次变化信息。



**数仓项目-拉链表技术介绍**

数据仓库的数据模型设计过程中，经常会遇到这样的需求：

表中的部分字段会被update，例如：

    用户的地址，产品的描述信息，品牌信息等等;

需要查看某一个时间点或者时间段的历史快照信息，例如：

    查看某一个产品在历史某一时间点的状态
    查看某一个用户在过去某一段时间内，更新过几次等等

变化的比例和频率不是很大，例如：

    总共有1000万的会员，每天新增和发生变化的有10万左右




**方案 ： 拉链表存储历史快照代码****实现**

操作步骤：

1.在原有dw层表上，添加额外的两列

- 生效日期（dw_start_date）

  表示某一条数据的生命周期开始时间，即数据从该时间开始有效

- 失效日期（dw_end_date）

  表示某一条数据的生命周期结束时间，数据到这一天失效



  ##### 2.只同步当天修改的数据到ods层

  拉链表算法实现

  - 编写SQL处理当天最新的数据（新添加的数据和修改过的数据）
  - 编写SQL处理dw层历史数据，重新计算之前的dw_end_date 

  拉链表的数据为：当天最新的数据 UNION ALL 历史数据
